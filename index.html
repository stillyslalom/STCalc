<!DOCTYPE html>
<html lang="en">
<head>
<title>Shock Tube Calculator</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" type="image/svg+xml" href="favicon.svg">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@400;600;700&display=swap" rel="stylesheet">
<link href="Shock%20Tube%20Calculator_files/web.css" rel="stylesheet" type="text/css">
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<style type="text/css">
/* Modern, clean styling */
* {
    box-sizing: border-box;
}

body {
    font-family: 'Source Sans Pro', Arial, sans-serif;
    margin: 0;
    padding: 20px;
    background-color: #f8f9fa;
    color: #212529;
    line-height: 1.5;
}

.container {
    max-width: 1200px;
    margin: 0 auto;
    background-color: #ffffff;
    padding: 40px;
    border-radius: 4px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

h1 {
    color: #212529;
    border-bottom: 3px solid #0066cc;
    padding-bottom: 12px;
    margin-top: 0;
    margin-bottom: 30px;
    font-size: 2em;
    font-weight: 700;
}

h2 {
    color: #212529;
    margin-top: 30px;
    margin-bottom: 20px;
    font-size: 1.5em;
    font-weight: 600;
}

h3 {
    color: #495057;
    margin-top: 20px;
    margin-bottom: 15px;
    font-size: 1.2em;
    font-weight: 600;
    clear: both;
}

hr {
    border: none;
    border-top: 1px solid #dee2e6;
    margin: 30px 0;
}

/* Form elements */
input[type="text"],
input[type="number"],
select {
    padding: 6px 10px;
    border: 1px solid #ced4da;
    border-radius: 3px;
    font-family: 'Source Sans Pro', Arial, sans-serif;
    font-size: 14px;
    background-color: #ffffff;
    transition: border-color 0.15s;
}

input[type="text"]:focus,
input[type="number"]:focus,
select:focus {
    outline: none;
    border-color: #0066cc;
}

input[type="text"]:disabled,
input[type="number"]:disabled {
    background-color: #e9ecef;
    cursor: not-allowed;
}

select {
    cursor: pointer;
    padding-right: 24px;
}

button,
input[type="button"],
input[type="reset"] {
    padding: 8px 16px;
    border: 1px solid #0066cc;
    border-radius: 3px;
    background-color: #0066cc;
    color: #ffffff;
    font-family: 'Source Sans Pro', Arial, sans-serif;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: background-color 0.15s;
}

button:hover,
input[type="button"]:hover,
input[type="reset"]:hover {
    background-color: #0052a3;
}

input[type="reset"] {
    background-color: #6c757d;
    border-color: #6c757d;
    margin-left: 8px;
}

input[type="reset"]:hover {
    background-color: #5a6268;
}

/* Table styling */
table {
    width: auto;
    border-collapse: collapse;
    margin-top: 15px;
    margin-bottom: 15px;
    font-size: 14px;
}

table td {
    padding: 6px 8px;
    border: 1px solid #dee2e6;
    white-space: nowrap;
}

table tr:first-child td {
    background-color: #f8f9fa;
    font-weight: 600;
    text-align: center;
}

table tr td:first-child {
    font-weight: 600;
    background-color: #f8f9fa;
}

table input {
    width: 90px;
    padding: 4px 6px;
    font-size: 13px;
}

table td:last-child {
    text-align: left;
    font-size: 13px;
    color: #6c757d;
}

/* Custom gas sections */
.custom-gas-section {
    background-color: #f8f9fa;
    padding: 15px;
    margin: 10px 0;
    border: 1px solid #dee2e6;
    border-radius: 3px;
}

.custom-gas-section h3 {
    margin-top: 0;
    font-size: 1em;
}

.mixture-component {
    margin-bottom: 8px;
}

.mixture-component select {
    min-width: 180px;
    margin-right: 8px;
}

.mixture-component input {
    width: 80px;
    margin-right: 8px;
}

.mixture-component button {
    padding: 6px 12px;
    font-size: 13px;
}

.custom-gas-library {
    background-color: #e7f3ff;
    padding: 15px;
    margin-bottom: 20px;
    border: 1px solid #b3d9ff;
    border-radius: 3px;
}

.custom-gas-library table {
    font-size: 13px;
    margin-top: 10px;
}

.custom-gas-library table tr:first-child td {
    background-color: #d1e8ff;
    font-weight: 600;
}

.custom-gas-library button {
    padding: 4px 10px;
    font-size: 12px;
}

/* Modal styles */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.5);
}

.modal-content {
    background-color: #ffffff;
    margin: 3% auto;
    padding: 30px;
    border: 1px solid #dee2e6;
    width: 90%;
    max-width: 800px;
    max-height: 85vh;
    overflow-y: auto;
    border-radius: 4px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 2px solid #0066cc;
}

.modal-header h2 {
    margin: 0;
    color: #0066cc;
}

.close {
    color: #6c757d;
    font-size: 32px;
    font-weight: bold;
    cursor: pointer;
    line-height: 1;
    transition: color 0.15s;
}

.close:hover,
.close:focus {
    color: #212529;
}

.equation-section {
    margin-bottom: 25px;
}

.equation-section h3 {
    color: #0066cc;
    margin-top: 20px;
    margin-bottom: 10px;
}

.equation-note {
    font-style: italic;
    color: #6c757d;
    margin-top: 20px;
    padding: 12px;
    background-color: #f8f9fa;
    border-left: 3px solid #0066cc;
}

/* Footer */
footer {
    text-align: center;
    margin-top: 40px;
    padding-top: 20px;
    border-top: 1px solid #dee2e6;
    color: #6c757d;
    font-size: 14px;
}

footer a {
    color: #0066cc;
    text-decoration: none;
}

footer a:hover {
    text-decoration: underline;
}

/* Notes section */
small {
    color: #6c757d;
    line-height: 1.6;
}

small a {
    color: #0066cc;
    text-decoration: none;
}

small a:hover {
    text-decoration: underline;
}

/* Form layout helpers */
.form-group {
    margin-bottom: 12px;
}

.form-label {
    display: inline-block;
    margin-left: 8px;
}

/* Mobile responsive styles */
@media screen and (max-width: 768px) {
    body {
        padding: 10px;
    }
    
    .container {
        padding: 15px;
    }
    
    h1 {
        font-size: 1.5em;
        padding-bottom: 8px;
        margin-bottom: 20px;
        border-bottom-width: 2px;
    }
    
    h2 {
        font-size: 1.25em;
        margin-top: 20px;
        margin-bottom: 15px;
    }
    
    h3 {
        font-size: 1.1em;
        margin-top: 15px;
        margin-bottom: 10px;
    }
    
    hr {
        margin: 20px 0;
    }
    
    /* Make table scrollable horizontally */
    table {
        display: block;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        font-size: 12px;
        margin-top: 10px;
        margin-bottom: 10px;
    }
    
    table td {
        padding: 4px 6px;
        font-size: 12px;
    }
    
    table input {
        width: 70px;
        padding: 3px 4px;
        font-size: 12px;
    }
    
    table td:last-child {
        font-size: 12px;
    }
    
    /* Form elements */
    input[type="text"],
    input[type="number"],
    select {
        padding: 5px 8px;
        font-size: 13px;
    }
    
    button,
    input[type="button"],
    input[type="reset"] {
        padding: 6px 12px;
        font-size: 13px;
    }
    
    .form-group {
        margin-bottom: 10px;
    }
    
    /* Custom gas sections */
    .custom-gas-section {
        padding: 10px;
        margin: 8px 0;
    }
    
    .mixture-component select {
        min-width: 150px;
        margin-right: 6px;
        font-size: 13px;
    }
    
    .mixture-component input {
        width: 70px;
        margin-right: 6px;
    }
    
    .mixture-component button {
        padding: 5px 10px;
        font-size: 12px;
    }
    
    .custom-gas-library {
        padding: 10px;
        margin-bottom: 15px;
    }
    
    .custom-gas-library table {
        font-size: 11px;
        display: block;
        overflow-x: auto;
    }
    
    /* Modal adjustments */
    .modal-content {
        width: 95%;
        padding: 20px;
        margin: 5% auto;
    }
    
    .modal-header h2 {
        font-size: 1.2em;
    }
    
    .close {
        font-size: 28px;
    }
    
    /* Footer */
    footer {
        font-size: 12px;
        margin-top: 30px;
        padding-top: 15px;
    }
    
    /* Notes section */
    small {
        font-size: 12px;
    }
    
    small input {
        font-size: 12px;
    }
}
</style>
</head>
<body>

<div class="container">

<script language="JavaScript1.2">



function calcShock() {

        var p1,p2,p5,p2p1,p5p2;  //pressure and ratio

        var t1,t2,t5,t2t1,t5t2;  //temperature and ratio

        var d1,d2,d5,d2d1,d5d2;  //density and ratio

        var a1,a2,a5;            //speed of sound

        var m,g,gp,gm,mw,ru,r;

        var u2,w;

        var mr,wr;

        var g4,mw4,a4,p4p1,p4,r4,t4,areafactor;

        var d4,p4p1exp,p4p1arg;

        m  = parseFloat(document.Shock.mach.value);

        p1 = parseFloat(document.Shock.pinit.value);

        t1 = parseFloat(document.Shock.tinit.value);

        areafactor = parseFloat(document.Shock.areafact.value);

        //decide driven gas;

        if (document.Shock.drivengas.value == "custom"){
            // Calculate properties for custom mixture
            var drivenProps = calculateMixtureProperties('driven');
            if (drivenProps === null) {
                return; // Error already shown in calculateMixtureProperties
            }
            g = drivenProps.gamma;
            mw = drivenProps.mw;
        }
        else if (document.Shock.drivengas.value == "1"){

              g=parseFloat(1.4020);

              mw=parseFloat(28.9660);

            }

        else if (document.Shock.drivengas.value == "2"){

             g=parseFloat(1.6700);

            mw=parseFloat(39.948000);

            }

        else if (document.Shock.drivengas.value == "3"){

             g=parseFloat(1.29700);

            mw=parseFloat(44.01000);

            }

        else if (document.Shock.drivengas.value == "4"){

             g=parseFloat(1.66700);

            mw=parseFloat(4.002602000);

            }

        else if (document.Shock.drivengas.value == "5"){

             g=parseFloat(1.66700);

            mw=parseFloat(20.179700);

            }

        else if (document.Shock.drivengas.value == "6"){

             g=parseFloat(1.40100);

            mw=parseFloat(28.0134000);

            }

        else if (document.Shock.drivengas.value == "7"){

             g=parseFloat(1.66700);

            mw=parseFloat(131.29000);

            }

        else if (document.Shock.drivengas.value == "8"){

             g=parseFloat(1.09200);

            mw=parseFloat(146.06000);

            }

		else if (document.Shock.drivengas.value == "9"){

             g=parseFloat(1.668);

            mw=parseFloat(21.98);

            }

        else if (document.Shock.drivengas.value == "10"){

             g=parseFloat(1.14000);

            mw=parseFloat(58.08000);

            }

        // decide driver gas

        if (document.Shock.drivergas.value == "custom"){
            // Calculate properties for custom mixture
            var driverProps = calculateMixtureProperties('driver');
            if (driverProps === null) {
                return; // Error already shown in calculateMixtureProperties
            }
            g4 = driverProps.gamma;
            mw4 = driverProps.mw;
        }
        else if (document.Shock.drivergas.value == "1"){

              g4=parseFloat(1.4020);

              mw4=parseFloat(28.9660);

            }

        else if (document.Shock.drivergas.value == "2"){

             g4=parseFloat(1.6700);

            mw4=parseFloat(39.948000);

            }

        else if (document.Shock.drivergas.value == "3"){

             g4=parseFloat(1.29700);

            mw4=parseFloat(44.01000);

            }

        else if (document.Shock.drivergas.value == "4"){

             g4=parseFloat(1.66700);

            mw4=parseFloat(4.002602000);

            }

        else if (document.Shock.drivergas.value == "5"){

             g4=parseFloat(1.66700);

            mw4=parseFloat(20.179700);

            }

        else if (document.Shock.drivergas.value == "6"){

             g4=parseFloat(1.40100);

            mw4=parseFloat(28.0134000);

            }

        else if (document.Shock.drivergas.value == "7"){

             g4=parseFloat(1.66700);

            mw4=parseFloat(131.29000);

            }

        else if (document.Shock.drivergas.value == "8"){

             g4=parseFloat(1.09200);

            mw4=parseFloat(146.06000);

            }

        else if (document.Shock.drivergas.value == "10"){

             g4=parseFloat(1.14000);

            mw4=parseFloat(58.08000);

            }

      	t4 = parseFloat(document.Shock.tid.value);

	//document.write("t4 " + t4 + "  ");    

        gp = g + 1.00;

        gm = g - 1.00;

      	//document.write("gm " + gm + "  ");

        //document.write("g " + g + "  ");

        //document.write("mw " + mw + "  ");

        ru=parseFloat(8314.510);

        //document.write("ru " + ru + "  ");

        r=ru/mw;

        //document.write("r " + r + "  ");

        a1=Math.sqrt(g*r*t1);

        w=a1*m;

        d1=p1/r/t1;

        //document.write("p2 " + t1 + "  ");

        //document.write("gp " + gp + "  ");

        //document.write("gm " + gm + "  ");

        //ees p2p1=1+((2*gamma_1)/gp_1)*(M_init^2-1);

        //

        //  State 2 properties

        //

        p2p1=1+2*g/gp*(Math.pow(m,2)-1);

        p2=p2p1*p1;

        t2t1=p2p1*((gp/gm+p2p1)/(1+gp/gm*p2p1));

        t2=t2t1*t1;

        a2=Math.sqrt(g*r*t2);

        //ees rho2rho1=(1+gp_1/gm_1*p2p1)/(gp_1/gm_1+p2p1)

	d2d1=(1+(gp/gm)*p2p1)/(gp/gm+p2p1);

	d2=d2d1*d1;

	//ees u_2=c_1/gamma_1*(p2p1-1)*((2*gamma_1/gp_1)/(p2p1+gm_1/gp_1))^0.5

	u2=a1/g*(p2p1-1)*(Math.sqrt((2*g/gp)/(p2p1+gm/gp)));

        //

        //  State 4 properties

        //

	//document.write("gm " + gm + "  ");

        r4=ru/mw4;

        a4=Math.sqrt(g4*r4*t4);

        //ees p4p1=p2p1*(1-((gamma_4-1)*(a_1/a_4)*(p2p1-1))/sqrt(2*gamma_1*(2*gamma_1+;

	//         (gamma_1+1)*(p2p1-1))))^(-2*gamma_4/(gamma_4-1)) ;

        p4p1exp=(-2*g4/(g4-1));

        p4p1arg=(1-((g4-1)*(a1/a4)*(p2p1-1))/Math.sqrt(2*g*(2*g+gp*(p2p1-1))));

	p4p1=p2p1*Math.pow(p4p1arg,p4p1exp);

	p4=p4p1*p1;

	d4=p4/r4/t4;

        //document.write("t4 " + t4 + "  ");

        //document.write("a4 " + a4 + "  ");

        //

        //  State 5 properties

        //

        p5p2=((3*g-1)*p2p1-gm)/(gm*p2p1+gp);

        p5=p5p2*p2;

        t5t2=p5p2*((gp/gm+p5p2)/(1+gp/gm*p5p2));

        t5=t5t2*t2;

        d5d2=(1+(gp/gm)*p5p2)/(gp/gm+p5p2);

	d5=d5d2*d2;

        a5=Math.sqrt(g*r*t5);

        wr=(d2*u2)/(d5-d2);

        mr=(wr+u2)/a2;

        document.Shock.pdriv.value = (p1/1e6).toPrecision(6);

        document.Shock.tdriv.value = t1.toPrecision(6);

        document.Shock.ddriv.value = d1.toPrecision(6);

        document.Shock.adriv.value = a1.toPrecision(6);

        document.Shock.pshocked.value = (p2/1e6).toPrecision(6);

        document.Shock.tshocked.value = t2.toPrecision(6);

        document.Shock.dshocked.value = d2.toPrecision(6);

        document.Shock.ashocked.value = a2.toPrecision(6);

        document.Shock.ushocked.value = u2.toPrecision(6);

        document.Shock.pfour.value = (p4/1e6).toPrecision(6);

        document.Shock.pfourpsig.value = ((((p4-101325.0)/101325.0)*14.696)/areafactor).toPrecision(6);

        document.Shock.tfour.value = t4.toPrecision(6);

        document.Shock.dfour.value = d4.toPrecision(6);

        document.Shock.afour.value = a4.toPrecision(6);

        document.Shock.preflect.value = (p5/1e6).toPrecision(6);

        document.Shock.treflect.value = t5.toPrecision(6);

        document.Shock.dreflect.value = d5.toPrecision(6);

        document.Shock.areflect.value = a5.toPrecision(6);

        document.Shock.wreflect.value = wr.toPrecision(6);

        document.Shock.mreflect.value = mr.toPrecision(6);

        document.Shock.wshocked.value = w.toPrecision(6);

        document.Shock.outmw.value = mw.toPrecision(6);

        document.Shock.outgamma.value = g.toPrecision(6);

        // Save calculator state to localStorage
        saveCalculatorState();

}



function calcTime() {

        var xwave,xtrig,twave,wactual,mactual,xint;

        var tdelayshock,tdelaymembrane,u2;

        xwave = parseFloat(document.Timing.xwave.value);

        twave = parseFloat(document.Timing.twave.value)/1000.00;

        u2 = parseFloat(document.Shock.ushocked.value);

        wactual=xwave/twave;

        mactual=wactual/parseFloat(document.Shock.adriv.value);

        xtrig = parseFloat(document.Timing.xtrig.value);

        xint = parseFloat(document.Timing.xint.value);

        tdelayshock=xtrig/wactual*1000;

        tdelaymembrane=(xint)/wactual*1000+(xtrig-xint)/u2*1000;

        document.Timing.wactual.value = wactual;

        document.Timing.mactual.value = mactual;

        document.Timing.tdelayshock.value = tdelayshock;

        document.Timing.tdelaymembrane.value = tdelaymembrane;

}



function calcBoost() {

        var drivervol,boostvol,prupture,percless,percmore,ru;

        var r,mw4,g4,psig,ppa,ppreboost,ppostboost,pboosttank;

        var deltap,deltam,t;

        psig=parseFloat(14.696);

        ppa=parseFloat(101325);

        drivervol = parseFloat(document.Boosttank.drivervol.value);

        boostvol = parseFloat(document.Boosttank.boostvol.value);

        prupture = parseFloat(document.Boosttank.prupture.value)*ppa/psig;

        percless = parseFloat(document.Boosttank.percless.value);

        percmore = parseFloat(document.Boosttank.percmore.value);

     

        // decide driver gas

        if (document.Shock.drivergas.value == "1"){

              g4=parseFloat(1.4020);

              mw4=parseFloat(28.9660);

            }

        if (document.Shock.drivergas.value == "2"){

             g4=parseFloat(1.6700);

            mw4=parseFloat(39.948000);

            }

        if (document.Shock.drivergas.value == "3"){

             g4=parseFloat(1.29700);

            mw4=parseFloat(44.01000);

            }

        if (document.Shock.drivergas.value == "4"){

             g4=parseFloat(1.66700);

            mw4=parseFloat(4.002602000);

            }

        if (document.Shock.drivergas.value == "5"){

             g4=parseFloat(1.66700);

            mw4=parseFloat(20.179700);

            }

        if (document.Shock.drivergas.value == "6"){

             g4=parseFloat(1.40100);

            mw4=parseFloat(28.0134000);

            }

        if (document.Shock.drivergas.value == "7"){

             g4=parseFloat(1.66700);

            mw4=parseFloat(131.29000);

            }

        if (document.Shock.drivergas.value == "8"){

             g4=parseFloat(1.09200);

            mw4=parseFloat(146.06000);

            }

        ru=parseFloat(8314.510);

        // document.write("ru " + ru + "  ");

        r=ru/mw4;

        ppreboost=prupture*(1-percless/100);

        ppostboost=prupture*(1+percmore/100);

        deltap=ppostboost-ppreboost;

        t=parseFloat(document.Shock.tid.value);
        
        deltam=deltap*drivervol/r/t;


        pboosttank=deltam/boostvol*r*t+prupture;

       // document.write("pboosttank " + pboosttank + "  ");

       document.Boosttank.ppreboost.value = ppreboost*psig/ppa

       document.Boosttank.ppostboost.value = ppostboost*psig/ppa

       document.Boosttank.pboosttank.value = pboosttank*psig/ppa

       

       

}

// Gas database with properties
var gasDatabase = {
    "1": {name: "Air", gamma: 1.4020, mw: 28.9660},
    "2": {name: "Argon", gamma: 1.6700, mw: 39.948000},
    "3": {name: "Carbon Dioxide", gamma: 1.29700, mw: 44.01000},
    "4": {name: "Helium", gamma: 1.66700, mw: 4.002602000},
    "5": {name: "Neon", gamma: 1.66700, mw: 20.179700},
    "6": {name: "Nitrogen", gamma: 1.40100, mw: 28.0134000},
    "7": {name: "Xenon", gamma: 1.66700, mw: 131.29000},
    "8": {name: "Sulfur Hexafluoride", gamma: 1.09200, mw: 146.06000},
    "10": {name: "Acetone Vapor", gamma: 1.14000, mw: 58.08000}
};

// Store mixture compositions
var mixtures = {
    driven: [],
    driver: []
};

// Custom gases stored in localStorage
var customGases = {};
var customGasCounter = 0;

// Load custom gases from localStorage on page load
function loadCustomGases() {
    try {
        var stored = localStorage.getItem('wistl_custom_gases');
        if (stored) {
            var gases = JSON.parse(stored);
            customGases = {};
            for (var i = 0; i < gases.length; i++) {
                var gas = gases[i];
                customGases[gas.id] = gas;
                // Update counter to avoid ID collisions
                var numPart = parseInt(gas.id.replace('custom_', ''));
                if (numPart >= customGasCounter) {
                    customGasCounter = numPart + 1;
                }
            }
        }
    } catch (e) {
        console.error('Error loading custom gases:', e);
    }
}

// Save custom gases to localStorage
function saveCustomGases() {
    try {
        var gasArray = [];
        for (var id in customGases) {
            gasArray.push(customGases[id]);
        }
        localStorage.setItem('wistl_custom_gases', JSON.stringify(gasArray));
    } catch (e) {
        alert('Error saving custom gases. Storage quota may be exceeded.');
        console.error('Error saving custom gases:', e);
    }
}

// Get all gases (predefined + custom)
function getAllGases() {
    var allGases = {};
    // Add predefined gases
    for (var id in gasDatabase) {
        allGases[id] = gasDatabase[id];
    }
    // Add custom gases
    for (var id in customGases) {
        allGases[id] = customGases[id];
    }
    return allGases;
}

// Clear all output fields
function clearOutputFields() {
    // Shock calculator outputs
    document.Shock.pdriv.value = '';
    document.Shock.tdriv.value = '';
    document.Shock.ddriv.value = '';
    document.Shock.adriv.value = '';
    document.Shock.pshocked.value = '';
    document.Shock.tshocked.value = '';
    document.Shock.dshocked.value = '';
    document.Shock.ashocked.value = '';
    document.Shock.ushocked.value = '';
    document.Shock.pfour.value = '';
    document.Shock.pfourpsig.value = '';
    document.Shock.tfour.value = '';
    document.Shock.dfour.value = '';
    document.Shock.afour.value = '';
    document.Shock.preflect.value = '';
    document.Shock.treflect.value = '';
    document.Shock.dreflect.value = '';
    document.Shock.areflect.value = '';
    document.Shock.wreflect.value = '';
    document.Shock.mreflect.value = '';
    document.Shock.wshocked.value = '';
    document.Shock.outmw.value = '';
    document.Shock.outgamma.value = '';
    
    // Timing calculator outputs
    document.Timing.wactual.value = '';
    document.Timing.mactual.value = '';
    document.Timing.tdelayshock.value = '';
    document.Timing.tdelaymembrane.value = '';
    
    // Boost tank calculator outputs
    document.Boosttank.ppreboost.value = '';
    document.Boosttank.ppostboost.value = '';
    document.Boosttank.pboosttank.value = '';
}

// Initialize custom gases on page load
window.onload = function() {
    loadCustomGases();
    updateCustomGasList();
    loadCalculatorState();
    clearOutputFields();
};

// Save calculator state to localStorage
function saveCalculatorState() {
    try {
        var state = {
            mach: document.Shock.mach.value,
            pinit: document.Shock.pinit.value,
            tinit: document.Shock.tinit.value,
            tid: document.Shock.tid.value,
            areafact: document.Shock.areafact.value,
            drivengas: document.Shock.drivengas.value,
            drivergas: document.Shock.drivergas.value,
            // Save calculated outputs for import into x-t diagram
            pfour: document.Shock.pfour.value,
            pshocked: document.Shock.pshocked.value,
            ushocked: document.Shock.ushocked.value
        };
        
        // If custom mixture is selected, save the mixture compositions
        if (state.drivengas === 'custom') {
            state.drivenMixture = [];
            for (var i = 0; i < mixtures.driven.length; i++) {
                var index = mixtures.driven[i];
                var gasSelect = document.getElementById('driven_gas_' + index);
                var fracInput = document.getElementById('driven_frac_' + index);
                if (gasSelect && fracInput && gasSelect.value) {
                    state.drivenMixture.push({
                        gasId: gasSelect.value,
                        fraction: fracInput.value
                    });
                }
            }
        }
        
        if (state.drivergas === 'custom') {
            state.driverMixture = [];
            for (var i = 0; i < mixtures.driver.length; i++) {
                var index = mixtures.driver[i];
                var gasSelect = document.getElementById('driver_gas_' + index);
                var fracInput = document.getElementById('driver_frac_' + index);
                if (gasSelect && fracInput && gasSelect.value) {
                    state.driverMixture.push({
                        gasId: gasSelect.value,
                        fraction: fracInput.value
                    });
                }
            }
        }
        
        localStorage.setItem('wistl_calculator_state', JSON.stringify(state));
    } catch (e) {
        console.error('Error saving calculator state:', e);
    }
}

// Load calculator state from localStorage
function loadCalculatorState() {
    try {
        var stored = localStorage.getItem('wistl_calculator_state');
        if (!stored) return;
        
        var state = JSON.parse(stored);
        
        // Restore basic inputs
        if (state.mach) document.Shock.mach.value = state.mach;
        if (state.pinit) document.Shock.pinit.value = state.pinit;
        if (state.tinit) document.Shock.tinit.value = state.tinit;
        if (state.tid) document.Shock.tid.value = state.tid;
        if (state.areafact) document.Shock.areafact.value = state.areafact;
        
        // Restore gas selections
        if (state.drivengas) {
            document.Shock.drivengas.value = state.drivengas;
            toggleMixtureInputs('driven');
            
            // Restore custom mixture if it was selected
            if (state.drivengas === 'custom' && state.drivenMixture && state.drivenMixture.length > 0) {
                // Clear any existing mixture components
                mixtures.driven = [];
                document.getElementById('driven_mixture_inputs').innerHTML = '';
                
                // Recreate mixture components
                for (var i = 0; i < state.drivenMixture.length; i++) {
                    addGasToMixture('driven');
                    var index = mixtures.driven[mixtures.driven.length - 1];
                    var gasSelect = document.getElementById('driven_gas_' + index);
                    var fracInput = document.getElementById('driven_frac_' + index);
                    
                    if (gasSelect && fracInput) {
                        gasSelect.value = state.drivenMixture[i].gasId;
                        fracInput.value = state.drivenMixture[i].fraction;
                    }
                }
                updateMixtureTotal('driven');
            }
        }
        
        if (state.drivergas) {
            document.Shock.drivergas.value = state.drivergas;
            toggleMixtureInputs('driver');
            
            // Restore custom mixture if it was selected
            if (state.drivergas === 'custom' && state.driverMixture && state.driverMixture.length > 0) {
                // Clear any existing mixture components
                mixtures.driver = [];
                document.getElementById('driver_mixture_inputs').innerHTML = '';
                
                // Recreate mixture components
                for (var i = 0; i < state.driverMixture.length; i++) {
                    addGasToMixture('driver');
                    var index = mixtures.driver[mixtures.driver.length - 1];
                    var gasSelect = document.getElementById('driver_gas_' + index);
                    var fracInput = document.getElementById('driver_frac_' + index);
                    
                    if (gasSelect && fracInput) {
                        gasSelect.value = state.driverMixture[i].gasId;
                        fracInput.value = state.driverMixture[i].fraction;
                    }
                }
                updateMixtureTotal('driver');
            }
        }
    } catch (e) {
        console.error('Error loading calculator state:', e);
    }
}

// Update the custom gases list display
function updateCustomGasList() {
    var listDiv = document.getElementById('custom_gas_list');
    var managementDiv = document.getElementById('custom_gas_management');
    
    if (!listDiv || !managementDiv) return;
    
    var gasCount = 0;
    for (var id in customGases) {
        gasCount++;
    }
    
    if (gasCount === 0) {
        managementDiv.style.display = 'none';
        return;
    }
    
    managementDiv.style.display = 'block';
    
    var html = '<table>';
    html += '<tr>';
    html += '<td>Gas Name</td>';
    html += '<td>Gamma (γ)</td>';
    html += '<td>MW (g/mol)</td>';
    html += '<td>Action</td>';
    html += '</tr>';
    
    for (var id in customGases) {
        var gas = customGases[id];
        html += '<tr>';
        html += '<td>★ ' + gas.name + '</td>';
        html += '<td>' + gas.gamma.toFixed(4) + '</td>';
        html += '<td>' + gas.mw.toFixed(4) + '</td>';
        html += '<td>';
        html += '<button type="button" onclick="deleteCustomGas(\'' + id + '\')">Delete</button>';
        html += '</td>';
        html += '</tr>';
    }
    
    html += '</table>';
    listDiv.innerHTML = html;
}

// Delete a custom gas
function deleteCustomGas(gasId) {
    var gas = customGases[gasId];
    if (!gas) return;
    
    if (!confirm('Are you sure you want to delete "' + gas.name + '"?\n\nThis will remove it from all mixture dropdowns.')) {
        return;
    }
    
    // Check if this gas is currently being used in any mixture
    var inUse = false;
    var types = ['driven', 'driver'];
    for (var t = 0; t < types.length; t++) {
        var type = types[t];
        for (var i = 0; i < mixtures[type].length; i++) {
            var index = mixtures[type][i];
            var select = document.getElementById(type + '_gas_' + index);
            if (select && select.value === gasId) {
                inUse = true;
                break;
            }
        }
        if (inUse) break;
    }
    
    if (inUse) {
        alert('Warning: This gas is currently selected in a mixture. It will be removed from the selection.');
    }
    
    // Delete the gas
    delete customGases[gasId];
    saveCustomGases();
    
    // Update the list
    updateCustomGasList();
    
    // Remove from all dropdowns and reset selections if this gas was selected
    for (var t = 0; t < types.length; t++) {
        var type = types[t];
        for (var i = 0; i < mixtures[type].length; i++) {
            var index = mixtures[type][i];
            var select = document.getElementById(type + '_gas_' + index);
            if (select) {
                // If this gas was selected, reset the selection
                if (select.value === gasId) {
                    select.value = '';
                }
                
                // Remove the option from the dropdown
                var options = select.options;
                for (var j = options.length - 1; j >= 0; j--) {
                    if (options[j].value === gasId) {
                        select.remove(j);
                        break;
                    }
                }
            }
        }
    }
    
    // Update mixture totals in case we removed a selected gas
    updateMixtureTotal('driven');
    updateMixtureTotal('driver');
}

// Toggle visibility of mixture input sections
function toggleMixtureInputs(type) {
    var selectElement = document.Shock[type + 'gas'];
    var divElement = document.getElementById(type + '_mixture_div');
    
    if (selectElement.value === 'custom') {
        divElement.style.display = 'block';
        // Initialize with one gas input if empty
        if (mixtures[type].length === 0) {
            addGasToMixture(type);
        }
    } else {
        divElement.style.display = 'none';
    }
}

// Add a new gas component to the mixture
function addGasToMixture(type) {
    var container = document.getElementById(type + '_mixture_inputs');
    var index = mixtures[type].length;
    
    var div = document.createElement('div');
    div.id = type + '_mix_' + index;
    div.className = 'mixture-component';
    
    var select = document.createElement('select');
    select.id = type + '_gas_' + index;
    select.onchange = function() { 
        handleGasSelection(type, index);
    };
    
    // Add gas options
    var emptyOption = document.createElement('option');
    emptyOption.value = '';
    emptyOption.text = 'Select Gas';
    select.appendChild(emptyOption);
    
    // Add "Define New Gas..." option
    var defineOption = document.createElement('option');
    defineOption.value = 'define_new';
    defineOption.text = '--- Define New Gas... ---';
    select.appendChild(defineOption);
    
    // Collect all gases and sort alphabetically
    var allGasOptions = [];
    
    // Add predefined gases
    for (var gasId in gasDatabase) {
        allGasOptions.push({
            value: gasId,
            text: gasDatabase[gasId].name,
            sortKey: gasDatabase[gasId].name
        });
    }
    
    // Add custom gases (with special marker)
    for (var gasId in customGases) {
        allGasOptions.push({
            value: gasId,
            text: '★ ' + customGases[gasId].name,
            sortKey: customGases[gasId].name
        });
    }
    
    // Sort alphabetically by name
    allGasOptions.sort(function(a, b) {
        return a.sortKey.localeCompare(b.sortKey);
    });
    
    // Add sorted options to select
    for (var i = 0; i < allGasOptions.length; i++) {
        var option = document.createElement('option');
        option.value = allGasOptions[i].value;
        option.text = allGasOptions[i].text;
        select.appendChild(option);
    }
    
    var label = document.createElement('span');
    label.textContent = ' Mole Fraction: ';
    
    var input = document.createElement('input');
    input.type = 'text';
    input.id = type + '_frac_' + index;
    input.size = 6;
    input.maxLength = 8;
    input.placeholder = '0.0';
    input.onkeyup = function() { updateMixtureTotal(type); };
    input.onchange = function() { updateMixtureTotal(type); };
    
    var removeBtn = document.createElement('button');
    removeBtn.type = 'button';
    removeBtn.innerHTML = 'Remove';
    removeBtn.onclick = function() { removeGasFromMixture(type, index); };
    
    div.appendChild(select);
    div.appendChild(label);
    div.appendChild(input);
    div.appendChild(document.createTextNode(' '));
    div.appendChild(removeBtn);
    
    // Container for custom gas definition form (initially hidden)
    var defineDiv = document.createElement('div');
    defineDiv.id = type + '_define_' + index;
    defineDiv.style.display = 'none';
    defineDiv.style.marginLeft = '20px';
    defineDiv.style.marginTop = '8px';
    defineDiv.style.padding = '10px';
    defineDiv.style.backgroundColor = '#fff3cd';
    defineDiv.style.border = '1px solid #ffc107';
    defineDiv.style.borderRadius = '3px';
    div.appendChild(document.createElement('br'));
    div.appendChild(defineDiv);
    
    container.appendChild(div);
    mixtures[type].push(index);
    
    updateMixtureTotal(type);
}

// Handle gas selection (including "Define New Gas" option)
function handleGasSelection(type, index) {
    var select = document.getElementById(type + '_gas_' + index);
    var defineDiv = document.getElementById(type + '_define_' + index);
    
    if (select.value === 'define_new') {
        // Show the custom gas definition form
        showDefineGasForm(type, index);
    } else {
        // Hide the definition form if it was showing
        if (defineDiv) {
            defineDiv.style.display = 'none';
        }
        updateMixtureTotal(type);
    }
}

// Show the custom gas definition form
function showDefineGasForm(type, index) {
    var defineDiv = document.getElementById(type + '_define_' + index);
    
    defineDiv.innerHTML = '<b>Define New Gas:</b><br>' +
        'Name: <input type="text" id="' + type + '_newgas_name_' + index + '" size="15" placeholder="e.g., Methane"> ' +
        'Gamma (γ): <input type="text" id="' + type + '_newgas_gamma_' + index + '" size="8" placeholder="e.g., 1.31"> ' +
        'MW (g/mol): <input type="text" id="' + type + '_newgas_mw_' + index + '" size="8" placeholder="e.g., 16.04"> ' +
        '<button type="button" onclick="saveCustomGas(\'' + type + '\', ' + index + ')">Save Gas</button> ' +
        '<button type="button" onclick="cancelDefineGas(\'' + type + '\', ' + index + ')">Cancel</button>';
    
    defineDiv.style.display = 'block';
}

// Save a new custom gas
function saveCustomGas(type, index) {
    var nameInput = document.getElementById(type + '_newgas_name_' + index);
    var gammaInput = document.getElementById(type + '_newgas_gamma_' + index);
    var mwInput = document.getElementById(type + '_newgas_mw_' + index);
    
    var name = nameInput.value.trim();
    var gamma = parseFloat(gammaInput.value);
    var mw = parseFloat(mwInput.value);
    
    // Validate inputs
    if (!name) {
        alert('Please enter a gas name.');
        nameInput.focus();
        return;
    }
    
    if (isNaN(gamma) || gamma <= 1.0) {
        alert('Gamma must be a number greater than 1.0 (thermodynamically required for ideal gases).');
        gammaInput.focus();
        return;
    }
    
    if (isNaN(mw) || mw <= 0) {
        alert('Molecular weight must be a positive number.');
        mwInput.focus();
        return;
    }
    
    // Check for duplicate name
    var allGases = getAllGases();
    for (var id in allGases) {
        if (allGases[id].name.toLowerCase() === name.toLowerCase()) {
            alert('A gas with this name already exists. Please use a different name.');
            nameInput.focus();
            return;
        }
    }
    
    // Create new custom gas
    var gasId = 'custom_' + customGasCounter++;
    customGases[gasId] = {
        id: gasId,
        name: name,
        gamma: gamma,
        mw: mw
    };
    
    // Save to localStorage
    saveCustomGases();
    
    // Update the gas selection dropdown
    var select = document.getElementById(type + '_gas_' + index);
    var option = document.createElement('option');
    option.value = gasId;
    option.text = '★ ' + name;
    option.selected = true;
    select.appendChild(option);
    
    // Hide the definition form
    var defineDiv = document.getElementById(type + '_define_' + index);
    defineDiv.style.display = 'none';
    
    // Update custom gases list
    updateCustomGasList();
    
    // Refresh all other dropdowns to include the new gas
    refreshAllGasDropdowns();
    
    alert('Custom gas "' + name + '" saved successfully!');
    updateMixtureTotal(type);
}

// Cancel custom gas definition
function cancelDefineGas(type, index) {
    var select = document.getElementById(type + '_gas_' + index);
    var defineDiv = document.getElementById(type + '_define_' + index);
    
    select.value = '';
    defineDiv.style.display = 'none';
    updateMixtureTotal(type);
}

// Refresh all gas dropdowns to include newly added custom gases
function refreshAllGasDropdowns() {
    var types = ['driven', 'driver'];
    
    for (var t = 0; t < types.length; t++) {
        var type = types[t];
        for (var i = 0; i < mixtures[type].length; i++) {
            var index = mixtures[type][i];
            var select = document.getElementById(type + '_gas_' + index);
            if (select) {
                var currentValue = select.value;
                
                // Remove old custom gas options
                var options = select.options;
                for (var j = options.length - 1; j >= 0; j--) {
                    if (options[j].value.indexOf('custom_') === 0) {
                        select.remove(j);
                    }
                }
                
                // Add updated custom gas options
                for (var gasId in customGases) {
                    var option = document.createElement('option');
                    option.value = gasId;
                    option.text = '★ ' + customGases[gasId].name;
                    select.appendChild(option);
                }
                
                // Restore previous selection if it still exists
                select.value = currentValue;
            }
        }
    }
}

// Remove a gas component from the mixture
function removeGasFromMixture(type, index) {
    var div = document.getElementById(type + '_mix_' + index);
    if (div) {
        div.remove();
        var idx = mixtures[type].indexOf(index);
        if (idx > -1) {
            mixtures[type].splice(idx, 1);
        }
        updateMixtureTotal(type);
    }
}

// Update and display the total mole fraction
function updateMixtureTotal(type) {
    var total = 0.0;
    var valid = true;
    
    for (var i = 0; i < mixtures[type].length; i++) {
        var index = mixtures[type][i];
        var input = document.getElementById(type + '_frac_' + index);
        if (input) {
            var val = parseFloat(input.value);
            if (!isNaN(val)) {
                total += val;
            }
        }
    }
    
    var totalSpan = document.getElementById(type + '_total');
    var displayTotal = Math.round(total * 100 * 100) / 100; // Round to 2 decimal places
    
    if (Math.abs(total - 1.0) < 0.001) {
        totalSpan.innerHTML = '<span style="color:#28a745;">Total: ' + displayTotal + '% ✓</span>';
    } else if (total > 0) {
        totalSpan.innerHTML = '<span style="color:#dc3545;">Total: ' + displayTotal + '% (must equal 100%)</span>';
    } else {
        totalSpan.innerHTML = '<span style="color:#6c757d;">Total: 0%</span>';
    }
}

// Calculate mixture properties (gamma and molecular weight)
function calculateMixtureProperties(type) {
    var totalFraction = 0.0;
    var components = [];
    
    // Collect all components
    for (var i = 0; i < mixtures[type].length; i++) {
        var index = mixtures[type][i];
        var gasSelect = document.getElementById(type + '_gas_' + index);
        var fracInput = document.getElementById(type + '_frac_' + index);
        
        if (gasSelect && fracInput) {
            var gasId = gasSelect.value;
            var fraction = parseFloat(fracInput.value);
            
            if (gasId && !isNaN(fraction) && fraction > 0) {
                components.push({
                    gasId: gasId,
                    fraction: fraction
                });
                totalFraction += fraction;
            }
        }
    }
    
    // Validate total fraction
    if (Math.abs(totalFraction - 1.0) > 0.001) {
        alert('Error: Mole fractions must sum to 1.0 (100%). Current total: ' + (totalFraction * 100).toFixed(2) + '%');
        return null;
    }
    
    if (components.length === 0) {
        alert('Error: No gas components specified in custom mixture.');
        return null;
    }
    
    // Get all available gases (predefined + custom)
    var allGases = getAllGases();
    
    // Calculate mixture molecular weight (simple weighted average)
    var mw_mix = 0.0;
    for (var i = 0; i < components.length; i++) {
        var gas = allGases[components[i].gasId];
        if (!gas) continue;
        mw_mix += components[i].fraction * gas.mw;
    }
    
    // Calculate mixture gamma using specific heats
    // For each gas: Cv = R/(gamma - 1), Cp = gamma * Cv
    // Then: Cv_mix = sum(x_i * Cv_i), Cp_mix = sum(x_i * Cp_i)
    // Finally: gamma_mix = Cp_mix / Cv_mix
    
    var cv_mix = 0.0;
    var cp_mix = 0.0;
    
    for (var i = 0; i < components.length; i++) {
        var gas = allGases[components[i].gasId];
        if (!gas) continue;
        var x = components[i].fraction;
        var gamma = gas.gamma;
        
        // Specific heats (normalized by R/MW, which cancels out in the ratio)
        var cv = 1.0 / (gamma - 1.0);
        var cp = gamma * cv;
        
        cv_mix += x * cv;
        cp_mix += x * cp;
    }
    
    var gamma_mix = cp_mix / cv_mix;
    
    return {
        gamma: gamma_mix,
        mw: mw_mix
    };
}

</script>

<!-- Custom Gas Management Section -->
<div id="custom_gas_management" class="custom-gas-library">
  <b>Custom Gases Library</b> <span style="font-size:smaller; color:#6c757d;">(Saved in browser storage)</span><br>
  <div id="custom_gas_list" style="margin-top:8px;">
    <span style="color:#6c757d; font-style:italic;">No custom gases defined yet.</span>
  </div>
</div>

<form name="Shock">
<h1>Shock Tube Calculator</h1>

<h2>Input</h2>

<div class="form-group">
<select name="drivengas" onchange="toggleMixtureInputs('driven')">
  <option value="">Select a Driven Gas</option>
  <option value="custom">Custom Mixture</option>
  <option value="1" selected="selected">Air</option> 
  <option value="2">Argon</option> 
  <option value="3">Carbon Dioxide</option>
  <option value="4">Helium</option> 
  <option value="5">Neon</option>
  <option value="6">Nitrogen</option> 
  <option value="8">Sulfur Hexafluoride</option>
  <option value="7">Xenon</option>
</select>
<span class="form-label">Driven Gas</span>
</div>

<div id="driven_mixture_div" class="custom-gas-section" style="display:none;">
  <h3>Custom Mixture (Mole Fractions):</h3>
  <div id="driven_mixture_inputs"></div>
  <button type="button" onclick="addGasToMixture('driven')">Add Gas Component</button>
  <span id="driven_total" style="margin-left:10px;"></span>
</div>

<div class="form-group">
<input maxlength="9" name="mach" size="9" value="1.53">
<span class="form-label">Mach Number (Desired)</span>
</div>

<div class="form-group">
<input maxlength="9" name="pinit" size="9" value="101325">
<span class="form-label">Pa, Initial Pressure, Driven Section</span>
</div>

<div class="form-group">
<input maxlength="9" name="tinit" size="9" value="300">
<span class="form-label">K, Initial Temperature, Driven Section</span>
</div>

<div class="form-group">
<select name="drivergas" onchange="toggleMixtureInputs('driver')">
  <option value="">Select a Driver Gas</option>
  <option value="custom">Custom Mixture</option>
  <option value="1" selected="selected">Air</option> 
  <option value="2">Argon</option> 
  <option value="3">Carbon Dioxide</option>
  <option value="4">Helium</option>
  <option value="5">Neon</option>
  <option value="6">Nitrogen</option> 
  <option value="8">Sulfur Hexafluoride</option>
  <option value="7">Xenon</option>
</select>
<span class="form-label">Driver Gas</span>
</div>

<div id="driver_mixture_div" class="custom-gas-section" style="display:none;">
  <h3>Custom Mixture (Mole Fractions):</h3>
  <div id="driver_mixture_inputs"></div>
  <button type="button" onclick="addGasToMixture('driver')">Add Gas Component</button>
  <span id="driver_total" style="margin-left:10px;"></span>
</div>

<div class="form-group">
<input maxlength="9" name="tid" size="9" value="300">
<span class="form-label">K, Initial Temperature, Driver Section</span>
</div>

<div class="form-group">
<input name="convert" onclick="calcShock()" type="button" value="Calculate">
<input name="reset" type="reset" value="Reset">
</div>

<hr>

<h2>Output</h2>

<table>
  <tr>
    <td></td>
    <td>Unshocked</td>
    <td>Shocked</td>
    <td>Driver</td>
    <td>Reshocked</td>
    <td></td>
  </tr>
  <tr>
    <td>Pressure</td>
    <td><input maxlength="9" name="pdriv" size="9" value="0.101325"></td>
    <td><input maxlength="9" name="pshocked" size="9" value="0.2599304145587011"></td>
    <td><input maxlength="9" name="pfour" size="9" value="0.7858588290526163"></td>
    <td><input maxlength="9" name="preflect" size="9" value="0.5922303848754988"></td>
    <td>MPa</td>
  </tr>
  <tr>
    <td>Temperature</td>
    <td><input maxlength="9" name="tdriv" size="9" value="300"></td>
    <td><input maxlength="9" name="tshocked" size="9" value="402.5381757242417"></td>
    <td><input maxlength="9" name="tfour" size="9" value="300"></td>
    <td><input maxlength="9" name="treflect" size="9" value="517.9845985458894"></td>
    <td>K</td>
  </tr>
  <tr>
    <td>Density</td>
    <td><input maxlength="9" name="ddriv" size="9" value="1.1766497965604708"></td>
    <td><input maxlength="9" name="dshocked" size="9" value="2.24958232829663"></td>
    <td><input maxlength="9" name="dfour" size="9" value="9.125888293412393"></td>
    <td><input maxlength="9" name="dreflect" size="9" value="3.9831412255673455"></td>
    <td>kg/m<sup>3</sup></td>
  </tr>
  <tr>
    <td>Sound Speed</td>
    <td><input maxlength="9" name="adriv" size="9" value="347.4631087739363"></td>
    <td><input maxlength="9" name="ashocked" size="9" value="402.48677117799417"></td>
    <td><input maxlength="9" name="afour" size="9" value="347.4631087739363"></td>
    <td><input maxlength="9" name="areflect" size="9" value="456.56908045297877"></td>
    <td>m/s</td>
  </tr>
  <tr>
    <td>Velocity</td>
    <td>0</td>
    <td><input maxlength="9" name="ushocked" size="9" value="253.55410935058"></td>
    <td>0</td>
    <td>0</td>
    <td>m/s</td>
  </tr>
</table>

<small>
<b>Notes:</b><br>
MW = <input maxlength="9" name="outmw" size="9" value="28.966">
Specific heat ratio = <input maxlength="9" name="outgamma" size="9" value="1.402"><br>
Initial wave speed = <input maxlength="9" name="wshocked" size="9" value="531.6185564241225"> m/s<br>
Reflected wave speed = <input maxlength="9" name="wreflect" size="9" value="329.02882305300926"> m/s,
M<sub>R</sub> = <input maxlength="9" name="mreflect" size="9" value="1.447458585280931"><br>
Approximate driver pressure (<input maxlength="5" name="areafact" size="5" value="1.35"> factor for area contraction) =
<input maxlength="9" name="pfourpsig" size="9" value="73.54339557717464"> psig<br>
<a href="#" onclick="showEquationsModal(); return false;">View Equations</a>
</small>

<hr>

<h2>X-T Diagram</h2>

<div style="background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 3px; padding: 15px; margin-bottom: 20px;">
  <p style="margin: 0 0 10px 0;">Generate an x-t diagram showing shock tube evolution over time by solving the 1D compressible Euler equations.</p>
  <button type="button" id="toggleXTDiagram" onclick="toggleXTDiagramSection()" style="padding: 8px 16px;">Show X-T Diagram Calculator ▼</button>
</div>

<div id="xtDiagramSection" style="display: none;">
  <!-- Gas Slab Configuration -->
  <h3>Gas Slab Configuration</h3>
  <p style="font-size: 14px; color: #6c757d;">Define the initial gas slabs in the shock tube. Slabs are ordered from left to right (driver first, then driven).</p>
  
  <div style="margin-bottom: 15px;">
    <button type="button" onclick="useCurrentCalculation()" style="background-color: #28a745; border-color: #28a745;">Use Current Calculation</button>
    <span id="xtImportInfo" style="margin-left: 10px; font-size: 13px; color: #28a745;"></span>
    <span id="xtImportWarning" style="margin-left: 10px; font-size: 13px; color: #dc3545;"></span>
  </div>
  
  <div id="xtSlabList" class="slab-list"></div>
  
  <button type="button" onclick="addXTSlab()">Add Gas Slab</button>
  
  <!-- Simulation Parameters -->
  <h3 style="margin-top: 25px;">Simulation Parameters</h3>
  
  <div class="form-group">
    <label for="xtGridPoints">Grid Points:</label>
    <input type="number" id="xtGridPoints" value="500" min="100" max="2000" step="50" style="width: 100px;">
    <span style="font-size: 12px; color: #6c757d; margin-left: 8px;">(100-2000, affects computation time)</span>
  </div>
  
  <div class="form-group">
    <label for="xtSimTime">Simulation Time:</label>
    <input type="number" id="xtSimTime" value="20" min="1" max="100" step="1" style="width: 100px;">
    <span style="font-size: 12px; color: #6c757d; margin-left: 8px;">ms</span>
  </div>
  
  <div class="form-group">
    <label for="xtSnapshotInterval">Snapshot Interval:</label>
    <input type="number" id="xtSnapshotInterval" value="0.1" min="0.01" max="10" step="0.01" style="width: 100px;">
    <span style="font-size: 12px; color: #6c757d; margin-left: 8px;">ms (time between saved frames)</span>
  </div>
  
  <div class="form-group">
    <label for="xtCflNumber">CFL Number:</label>
    <input type="number" id="xtCflNumber" value="0.4" min="0.1" max="0.9" step="0.05" style="width: 100px;">
    <span style="font-size: 12px; color: #6c757d; margin-left: 8px;">(stability parameter, 0.4 recommended)</span>
  </div>
  
  <!-- Simulation Controls -->
  <div style="margin: 20px 0;">
    <button type="button" id="xtRunBtn" onclick="runXTSimulation()" style="background-color: #28a745; border-color: #28a745;">Run Simulation</button>
    <button type="button" onclick="resetXTSimulation()" style="background-color: #6c757d; border-color: #6c757d; margin-left: 8px;">Reset</button>
  </div>
  
  <!-- Progress Bar -->
  <div id="xtProgressContainer" style="display: none; margin: 15px 0;">
    <div style="width: 100%; background-color: #e9ecef; border-radius: 3px; overflow: hidden;">
      <div id="xtProgressFill" style="width: 0%; height: 30px; background-color: #0066cc; color: white; display: flex; align-items: center; justify-content: center; font-weight: 600; transition: width 0.3s;">0%</div>
    </div>
  </div>
  
  <!-- Messages -->
  <div id="xtMessageContainer" style="margin: 15px 0;"></div>
  
  <!-- Canvas for X-T Diagram -->
  <div id="xtCanvasContainer" style="display: none; margin-top: 20px;">
    <canvas id="xtCanvas" style="border: 1px solid #dee2e6; border-radius: 3px; max-width: 100%;"></canvas>
    
    <!-- Statistics below canvas -->
    <div id="xtStatsContainer" style="display: none; margin: 20px 0; padding: 15px; background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 3px;">
      <h4 style="margin-top: 0; margin-bottom: 12px; color: #495057; font-size: 14px; font-weight: 600;">Simulation Statistics</h4>
      <div id="xtStatsContent" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;"></div>
    </div>
    
    <div style="margin-top: 15px;">
      <button type="button" onclick="exportXTImage()">Download Image (PNG)</button>
      <button type="button" onclick="exportXTDataCSV()">Download X-T Data (CSV)</button>
      <button type="button" onclick="exportXTTracerCSV()">Download Tracer Data (CSV)</button>
      <button type="button" onclick="exportXTJSON()" style="background-color: #6c757d; border-color: #6c757d; margin-left: 8px;">Download Complete Data (JSON)</button>
    </div>
  </div>
</div>

<hr>

<h2>Timing Issues</h2>
</form>

<form name="Timing">
<h3>Input</h3>

<div class="form-group">
<input maxlength="9" name="xwave" size="9" value="0.654">
<span class="form-label">m, Distance Between Pressure Transducers</span>
</div>

<div class="form-group">
<input maxlength="9" name="twave" size="9" value="">
<span class="form-label">ms, Time Between Pressure Transducers</span>
</div>

<div class="form-group">
<input maxlength="9" name="xtrig" size="9" value="0.859">
<span class="form-label">m, Distance Between Trigger Transducer and Window Centerline</span>
</div>

<div class="form-group">
<input maxlength="9" name="xint" size="9" value="0.4">
<span class="form-label">m, Distance Between Trigger Transducer and Interface</span>
</div>

<h3>Output</h3>

<div class="form-group">
<input maxlength="9" name="wactual" size="9" value="">
<span class="form-label">m/s, Actual Wave Speed</span>
</div>

<div class="form-group">
<input maxlength="9" name="mactual" size="9" value="">
<span class="form-label">Actual Mach Number</span>
</div>

<div class="form-group">
<input maxlength="9" name="tdelayshock" size="9" value="">
<span class="form-label">ms, Estimated Delay Time for Shock</span>
</div>

<div class="form-group">
<input maxlength="9" name="tdelaymembrane" size="9" value="">
<span class="form-label">ms, Estimated Delay Time for Membrane</span>
</div>

<div class="form-group">
<input name="convert" onclick="calcTime()" type="button" value="Calculate">
<input name="reset" type="reset" value="Reset">
</div>
</form>

<hr>

<h2>Boost Tank</h2>

<form name="Boosttank">
<h3>Input</h3>

<div class="form-group">
<input maxlength="9" name="drivervol" size="9" value="0.2862">
<span class="form-label">m<sup>3</sup>, Volume of the Driver</span>
</div>

<div class="form-group">
<input maxlength="9" name="boostvol" size="9" value="0.0538">
<span class="form-label">m<sup>3</sup>, Volume of the Boost Tank</span>
</div>

<div class="form-group">
<input maxlength="9" name="prupture" size="9" value="">
<span class="form-label">psig, Diaphragm Rupture Pressure</span>
</div>

<div class="form-group">
<input maxlength="9" name="percless" size="9" value="5">
<span class="form-label">%, Less than Rupture Pressure (for Pre-boost)</span>
</div>

<div class="form-group">
<input maxlength="9" name="percmore" size="9" value="20">
<span class="form-label">%, More than Rupture Pressure (for Post-boost)</span>
</div>

<h3>Output</h3>

<div class="form-group">
<input maxlength="9" name="ppreboost" size="9" value="">
<span class="form-label">psig, Pre-boost Driver Pressure</span>
</div>

<div class="form-group">
<input maxlength="9" name="ppostboost" size="9" value="">
<span class="form-label">psig, Post-boost Driver Pressure</span>
</div>

<div class="form-group">
<input maxlength="9" name="pboosttank" size="9" value="">
<span class="form-label">psig, Required Boost Tank Pressure</span>
</div>

<div class="form-group">
<input name="convert" onclick="calcBoost()" type="button" value="Calculate">
<input name="reset" type="reset" value="Reset">
</div>
</form>

</div>

<footer>
Last updated Jan. 16, 2026 by Alex Ames; original calculator by Jason Oakley. Submit issues & feature requests on <a href="https://github.com/stillyslalom/STCalc" target="_blank">GitHub</a>.
</footer>

<!-- Equations Modal -->
<div id="equationsModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Gasdynamic Equations for a Shock Wave</h2>
      <span class="close" onclick="closeEquationsModal()">&times;</span>
    </div>
    
    <div class="equation-section">
      <h3>List of Variables</h3>
      <p>
        \(a \equiv \text{speed of sound}\)<br>
        \(M \equiv \text{Mach number}\)<br>
        \(p \equiv \text{pressure}\)<br>
        \(T \equiv \text{temperature}\)<br>
        \(u_2 \equiv \text{particle velocity}\)<br>
        \(W \equiv \text{speed of wave}\)<br>
        \(\gamma \equiv \text{specific heat ratio}\)<br>
        \(\rho \equiv \text{density}\)
      </p>
    </div>

    <div class="equation-section">
      <h3>Basic Relationships</h3>
      <p>$$M \equiv \frac{W}{a}$$</p>
    </div>

    <div class="equation-section">
      <h3>Jump Relations Across Shock (State 2 - Shocked)</h3>
      
      <p><strong>Pressure Ratio:</strong></p>
      <p>$$\frac{p_2}{p_1} = 1 + \frac{2\gamma}{\gamma+1}\left(M^2-1\right)$$</p>
      
      <p><strong>Temperature Ratio:</strong></p>
      <p>$$\frac{T_2}{T_1} = \frac{p_2}{p_1}\left(\frac{\frac{\gamma+1}{\gamma-1}+\frac{p_2}{p_1}}{1+\frac{\gamma+1}{\gamma-1}\left[\frac{p_2}{p_1}\right]}\right)$$</p>
      
      <p><strong>Density Ratio:</strong></p>
      <p>$$\frac{\rho_2}{\rho_1} = \frac{1+\frac{\gamma+1}{\gamma-1}\left(\frac{p_2}{p_1}\right)}{\frac{\gamma+1}{\gamma-1}+\frac{p_2}{p_1}}$$</p>
      
      <p><strong>Particle Velocity:</strong></p>
      <p>$$u_2 = \frac{a_1}{\gamma}\left(\frac{p_2}{p_1}-1\right)\left(\frac{\frac{2\gamma}{\gamma+1}}{\frac{p_2}{p_1}+\frac{\gamma-1}{\gamma+1}}\right)^{1/2}$$</p>
    </div>

    <div class="equation-section">
      <h3>Reflected Wave Properties (State 5)</h3>
      
      <p><strong>Pressure Ratio:</strong></p>
      <p>$$\frac{p_5}{p_2} = \frac{(3\gamma-1)\frac{p_2}{p_1}-(\gamma-1)}{(\gamma-1)\frac{p_2}{p_1}+(\gamma+1)}$$</p>
      
      <p><strong>Temperature Ratio:</strong></p>
      <p>$$\frac{T_5}{T_2} = \frac{p_5}{p_2}\left(\frac{\frac{\gamma+1}{\gamma-1}+\frac{p_5}{p_2}}{1+\frac{\gamma+1}{\gamma-1}\left[\frac{p_5}{p_2}\right]}\right)$$</p>
      
      <p><strong>Density Ratio:</strong></p>
      <p>$$\frac{\rho_5}{\rho_2} = \frac{1+\frac{\gamma+1}{\gamma-1}\left(\frac{p_5}{p_2}\right)}{\frac{\gamma+1}{\gamma-1}+\frac{p_5}{p_2}}$$</p>
      
      <p><strong>Reflected Wave Speed and Mach Number:</strong></p>
      <p>$$W_R = \frac{\rho_2 u_2}{\rho_5-\rho_2}$$</p>
      <p>$$M_R = \frac{W_R+u_2}{a_2}$$</p>
    </div>

    <div class="equation-section">
      <h3>Driver Section Properties (State 4)</h3>
      <p>$$\frac{p_4}{p_1} = \frac{p_2}{p_1}\left(1-\frac{(\gamma_4-1)(a_1/a_4)(p_2/p_1-1)}{\sqrt{2\gamma_1\left[2\gamma_1+(\gamma_1+1)(p_2/p_1-1)\right]}}\right)^{-2\gamma_4/(\gamma_4-1)}$$</p>
    </div>

    <div class="equation-note">
      <strong>Reference:</strong> Equations taken from <em>Modern Compressible Flow with Historical Perspective</em>, Anderson, 2nd ed.
    </div>
  </div>
</div>

<script>
function showEquationsModal() {
    document.getElementById('equationsModal').style.display = 'block';
    // Trigger MathJax to render the equations
    if (window.MathJax) {
        MathJax.typesetPromise();
    }
}

function closeEquationsModal() {
    document.getElementById('equationsModal').style.display = 'none';
}

// Close modal when clicking outside of it
window.onclick = function(event) {
    var modal = document.getElementById('equationsModal');
    if (event.target == modal) {
        closeEquationsModal();
    }
}
</script>

<!-- Load X-T Diagram JavaScript -->
<script src="js/xt-mixture.js"></script>
<script src="js/euler-solver.js"></script>
<script src="js/xt-visualization.js"></script>

<style>
/* X-T Diagram slab list styling */
.slab-list {
    margin: 15px 0;
}

.slab-item {
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 3px;
    padding: 15px;
    margin-bottom: 10px;
    display: grid;
    grid-template-columns: auto 1fr auto;
    gap: 15px;
    align-items: center;
}

.slab-number {
    font-weight: 700;
    font-size: 18px;
    color: #0066cc;
    min-width: 40px;
}

.slab-controls {
    display: flex;
    gap: 10px;
    align-items: flex-end;
}

.slab-field {
    display: flex;
    flex-direction: column;
}

.slab-field label {
    font-size: 12px;
    font-weight: 600;
    color: #495057;
    margin-bottom: 4px;
}

.slab-field select {
    width: 180px;
}

.slab-field input {
    width: 90px;
}

.slab-field:first-child input {
    width: 80px;
}

.slab-actions {
    display: flex;
    flex-direction: row;
    gap: 5px;
}

.slab-actions button {
    padding: 6px 10px;
    font-size: 13px;
    min-width: auto;
}

.slab-actions button.danger {
    background-color: #dc3545;
    border-color: #dc3545;
}

.slab-actions button.danger:hover {
    background-color: #c82333;
}

.slab-actions button:disabled {
    background-color: #6c757d;
    border-color: #6c757d;
    opacity: 0.5;
    cursor: not-allowed;
}
</style>

<script>
// X-T Diagram state
var xtSlabs = [];
var xtSlabCounter = 0;
var xtSlabMixtures = {}; // Store mixture compositions for slabs with custom mixtures
var xtSolver = null;
var xtVisualization = null;
var xtResults = null;
var xtSuppressRender = false; // Flag to suppress rendering during batch operations

// Toggle X-T Diagram section
function toggleXTDiagramSection() {
    var section = document.getElementById('xtDiagramSection');
    var btn = document.getElementById('toggleXTDiagram');
    
    if (section.style.display === 'none') {
        section.style.display = 'block';
        btn.textContent = 'Hide X-T Diagram Calculator ▲';
        
        // Initialize visualization if not already done
        if (!xtVisualization) {
            xtVisualization = new XTVisualization('xtCanvas', {
                width: 1000,
                height: 600
            });
        }
        
        // Add default slabs if none exist
        if (xtSlabs.length === 0) {
            addXTSlab({ gas: '4', pressure: 400000, temperature: 300, length: 3 }); // Driver (Helium)
            addXTSlab({ gas: '1', pressure: 101325, temperature: 300, length: 6 }); // Driven (Air)
        }
    } else {
        section.style.display = 'none';
        btn.textContent = 'Show X-T Diagram Calculator ▼';
    }
}

// Use current calculation to populate slabs
function useCurrentCalculation() {
    // Check if calculation has been run
    var pfour = document.Shock.pfour.value;
    if (!pfour || pfour === '') {
        document.getElementById('xtImportWarning').textContent = '⚠ Please run the shock tube calculation first.';
        document.getElementById('xtImportInfo').textContent = '';
        return;
    }
    
    // Clear warnings and info
    document.getElementById('xtImportWarning').textContent = '';
    document.getElementById('xtImportInfo').textContent = '';
    
    // Clear existing slabs
    xtSlabs = [];
    xtSlabCounter = 0;
    xtSlabMixtures = {}; // Clear mixture data
    
    // Suppress rendering during batch import
    xtSuppressRender = true;
    
    // Get driver gas info
    var driverGasId = document.Shock.drivergas.value;
    var driverP = parseFloat(pfour) * 1e6; // Convert MPa to Pa
    var driverT = parseFloat(document.Shock.tid.value);
    
    // Get driven gas info
    var drivenGasId = document.Shock.drivengas.value;
    var drivenP = parseFloat(document.Shock.pinit.value);
    var drivenT = parseFloat(document.Shock.tinit.value);
    
    // Add driver slab
    if (driverGasId === 'custom') {
        // Import driver custom mixture - capture ID AFTER adding slab
        addXTSlab({ gas: 'custom_mixture', pressure: driverP, temperature: driverT, length: 3 });
        var driverSlabId = xtSlabs[xtSlabs.length - 1].id;
        
        // Copy mixture composition from shock tube calculator
        xtSlabMixtures[driverSlabId] = [];
        for (var i = 0; i < mixtures.driver.length; i++) {
            var index = mixtures.driver[i];
            var gasSelect = document.getElementById('driver_gas_' + index);
            var fracInput = document.getElementById('driver_frac_' + index);
            
            if (gasSelect && fracInput && gasSelect.value) {
                var compId = xtMixtureComponentCounter++;
                xtSlabMixtures[driverSlabId].push({
                    id: compId,
                    gasId: gasSelect.value,
                    fraction: parseFloat(fracInput.value)
                });
            }
        }
    } else {
        addXTSlab({ gas: driverGasId, pressure: driverP, temperature: driverT, length: 3 });
    }
    
    // Add driven slab
    if (drivenGasId === 'custom') {
        // Import driven custom mixture - capture ID AFTER adding slab
        addXTSlab({ gas: 'custom_mixture', pressure: drivenP, temperature: drivenT, length: 6 });
        var drivenSlabId = xtSlabs[xtSlabs.length - 1].id;
        
        // Copy mixture composition from shock tube calculator
        xtSlabMixtures[drivenSlabId] = [];
        for (var i = 0; i < mixtures.driven.length; i++) {
            var index = mixtures.driven[i];
            var gasSelect = document.getElementById('driven_gas_' + index);
            var fracInput = document.getElementById('driven_frac_' + index);
            
            if (gasSelect && fracInput && gasSelect.value) {
                var compId = xtMixtureComponentCounter++;
                xtSlabMixtures[drivenSlabId].push({
                    id: compId,
                    gasId: gasSelect.value,
                    fraction: parseFloat(fracInput.value)
                });
            }
        }
    } else {
        addXTSlab({ gas: drivenGasId, pressure: drivenP, temperature: drivenT, length: 6 });
    }
    
    // Re-enable rendering and render once with all data ready
    xtSuppressRender = false;
    renderXTSlabs();
    
    // Show import info
    var driverDesc = driverGasId === 'custom' ? 'Custom Mixture' : getAllGases()[driverGasId].name;
    var drivenDesc = drivenGasId === 'custom' ? 'Custom Mixture' : getAllGases()[drivenGasId].name;
    var info = '✓ Imported: ' + driverDesc + ' (driver) + ' + drivenDesc + ' (driven)';
    document.getElementById('xtImportInfo').textContent = info;
}

// Add a gas slab
function addXTSlab(config = {}) {
    var id = xtSlabCounter++;
    var slab = {
        id: id,
        gas: config.gas || '',
        pressure: config.pressure || 101325,
        temperature: config.temperature || 300,
        length: config.length || 1
    };
    
    xtSlabs.push(slab);
    
    // Only render if not suppressed (during batch operations)
    if (!xtSuppressRender) {
        renderXTSlabs();
    }
}

// Remove a slab
function removeXTSlab(id) {
    xtSlabs = xtSlabs.filter(s => s.id !== id);
    renderXTSlabs();
}

// Move slab up
function moveXTSlabUp(id) {
    var index = xtSlabs.findIndex(s => s.id === id);
    if (index > 0) {
        var temp = xtSlabs[index - 1];
        xtSlabs[index - 1] = xtSlabs[index];
        xtSlabs[index] = temp;
        renderXTSlabs();
    }
}

// Move slab down
function moveXTSlabDown(id) {
    var index = xtSlabs.findIndex(s => s.id === id);
    if (index < xtSlabs.length - 1) {
        var temp = xtSlabs[index + 1];
        xtSlabs[index + 1] = xtSlabs[index];
        xtSlabs[index] = temp;
        renderXTSlabs();
    }
}

// Update slab property
function updateXTSlab(id, property, value) {
    var slab = xtSlabs.find(s => s.id === id);
    if (slab) {
        slab[property] = parseFloat(value) || value;
    }
}

// Generate gas options HTML
function generateXTGasOptions(selectedGas) {
    var allGases = getAllGases();
    var options = '<option value="">Select Gas</option>';
    options += '<option value="custom_mixture"' + (selectedGas === 'custom_mixture' ? ' selected' : '') + '>Custom Mixture</option>';
    options += '<option disabled>──────────</option>';
    
    var gasEntries = Object.entries(allGases).sort(function(a, b) {
        return a[1].name.localeCompare(b[1].name);
    });
    
    for (var i = 0; i < gasEntries.length; i++) {
        var id = gasEntries[i][0];
        var gas = gasEntries[i][1];
        var selected = id === selectedGas ? 'selected' : '';
        var prefix = id.startsWith('custom_') ? '★ ' : '';
        options += '<option value="' + id + '" ' + selected + '>' + prefix + gas.name + '</option>';
    }
    
    return options;
}

// Render slab list
function renderXTSlabs() {
    var container = document.getElementById('xtSlabList');
    
    if (xtSlabs.length === 0) {
        container.innerHTML = '<p style="color: #6c757d;">No slabs configured. Add at least one slab to begin.</p>';
        return;
    }
    
    // Store current values before rebuilding
    var currentValues = {};
    for (var i = 0; i < xtSlabs.length; i++) {
        var slab = xtSlabs[i];
        var selectElem = document.getElementById('xt_slab_gas_' + slab.id);
        if (selectElem) {
            currentValues[slab.id] = selectElem.value;
        }
    }
    
    var html = '';
    for (var i = 0; i < xtSlabs.length; i++) {
        var slab = xtSlabs[i];
        // Use stored value if available, otherwise use slab.gas
        var selectedGas = currentValues[slab.id] !== undefined ? currentValues[slab.id] : slab.gas;
        
        html += '<div class="slab-item" id="xt_slab_item_' + slab.id + '">';
        html += '<div class="slab-number">#' + (i + 1) + '</div>';
        html += '<div class="slab-controls">';
        html += '<div class="slab-field">';
        html += '<label>Gas</label>';
        html += '<select id="xt_slab_gas_' + slab.id + '" onchange="updateXTSlab(' + slab.id + ', \'gas\', this.value); toggleXTSlabMixture(' + slab.id + ')">';
        html += generateXTGasOptions(selectedGas);
        html += '</select>';
        html += '</div>';
        html += '<div class="slab-field">';
        html += '<label>Pressure (kPa)</label>';
        html += '<input type="number" value="' + (slab.pressure / 1000).toFixed(1) + '" ';
        html += 'onchange="updateXTSlab(' + slab.id + ', \'pressure\', this.value * 1000)" step="1" min="1">';
        html += '</div>';
        html += '<div class="slab-field">';
        html += '<label>Temperature (K)</label>';
        html += '<input type="number" value="' + slab.temperature + '" ';
        html += 'onchange="updateXTSlab(' + slab.id + ', \'temperature\', this.value)" step="1" min="1">';
        html += '</div>';
        html += '<div class="slab-field">';
        html += '<label>Length (m)</label>';
        html += '<input type="number" value="' + slab.length + '" ';
        html += 'onchange="updateXTSlab(' + slab.id + ', \'length\', this.value)" step="0.1" min="0.1">';
        html += '</div>';
        html += '</div>';
        html += '<div class="slab-actions">';
        html += '<button type="button" onclick="moveXTSlabUp(' + slab.id + ')" ' + (i === 0 ? 'disabled' : '') + '>↑</button>';
        html += '<button type="button" onclick="moveXTSlabDown(' + slab.id + ')" ' + (i === xtSlabs.length - 1 ? 'disabled' : '') + '>↓</button>';
        html += '<button type="button" class="danger" onclick="removeXTSlab(' + slab.id + ')">Remove</button>';
        html += '</div>';
        html += '</div>';
    }
    
    container.innerHTML = html;
    
    // Explicitly set dropdown values after HTML render (more reliable than selected attribute)
    for (var i = 0; i < xtSlabs.length; i++) {
        var slab = xtSlabs[i];
        var select = document.getElementById('xt_slab_gas_' + slab.id);
        if (select) {
            select.value = slab.gas;
        }
    }
    
    // Re-initialize mixture UIs for slabs that have custom mixture selected
    for (var i = 0; i < xtSlabs.length; i++) {
        var slab = xtSlabs[i];
        if (slab.gas === 'custom_mixture') {
            toggleXTSlabMixture(slab.id);
        }
    }
}

// Validate configuration
function validateXTConfiguration() {
    if (xtSlabs.length === 0) {
        showXTMessage('Please add at least one gas slab.', 'error');
        return false;
    }
    
    for (var i = 0; i < xtSlabs.length; i++) {
        var slab = xtSlabs[i];
        
        if (!slab.gas) {
            showXTMessage('Slab #' + (i + 1) + ': Please select a gas.', 'error');
            return false;
        }
        
        if (slab.pressure <= 0) {
            showXTMessage('Slab #' + (i + 1) + ': Pressure must be positive.', 'error');
            return false;
        }
        
        if (slab.temperature <= 0) {
            showXTMessage('Slab #' + (i + 1) + ': Temperature must be positive.', 'error');
            return false;
        }
        
        if (slab.length <= 0) {
            showXTMessage('Slab #' + (i + 1) + ': Length must be positive.', 'error');
            return false;
        }
    }
    
    return true;
}

// Run X-T simulation
function runXTSimulation() {
    if (!validateXTConfiguration()) {
        return;
    }
    
    var runBtn = document.getElementById('xtRunBtn');
    runBtn.disabled = true;
    runBtn.textContent = 'Running...';
    
    document.getElementById('xtProgressContainer').style.display = 'block';
    document.getElementById('xtCanvasContainer').style.display = 'none';
    document.getElementById('xtStatsContainer').style.display = 'none';
    
    var nx = parseInt(document.getElementById('xtGridPoints').value);
    var simTime = parseFloat(document.getElementById('xtSimTime').value) / 1000;
    var snapshotInterval = parseFloat(document.getElementById('xtSnapshotInterval').value) / 1000;
    var cfl = parseFloat(document.getElementById('xtCflNumber').value);
    
    var slabData = [];
    try {
        slabData = xtSlabs.map(function(slab) {
            var props = getXTSlabGasProperties(slab);
            return {
                gasId: props.gasName,  // Use human-readable name
                gamma: props.gamma,
                mw: props.mw,
                pressure: slab.pressure,
                temperature: slab.temperature,
                length: slab.length
            };
        });
    } catch (error) {
        showXTMessage('Configuration error: ' + error.message, 'error');
        runBtn.disabled = false;
        runBtn.textContent = 'Run Simulation';
        return;
    }
    
    xtSolver = new EulerSolver({
        nx: nx,
        finalTime: simTime,
        cfl: cfl,
        xtInterval: snapshotInterval
    });
    
    try {
        xtSolver.initialize(slabData);
        showXTMessage('Simulation initialized. Running solver...', 'info');
        
        setTimeout(function() {
            try {
                xtSolver.run(function(progress) {
                    var percent = Math.round(progress * 100);
                    document.getElementById('xtProgressFill').style.width = percent + '%';
                    document.getElementById('xtProgressFill').textContent = percent + '%';
                });
                
                xtResults = xtSolver.getResults();
                xtVisualization.setData(xtResults);
                xtVisualization.render();
                
                document.getElementById('xtCanvasContainer').style.display = 'block';
                displayXTStatistics(xtResults);
                
                showXTMessage('Simulation completed successfully!', 'success');
            } catch (error) {
                showXTMessage('Simulation error: ' + error.message, 'error');
                console.error(error);
            } finally {
                runBtn.disabled = false;
                runBtn.textContent = 'Run Simulation';
                document.getElementById('xtProgressContainer').style.display = 'none';
            }
        }, 100);
    } catch (error) {
        showXTMessage('Initialization error: ' + error.message, 'error');
        console.error(error);
        runBtn.disabled = false;
        runBtn.textContent = 'Run Simulation';
        document.getElementById('xtProgressContainer').style.display = 'none';
    }
}

// Display statistics
function displayXTStatistics(results) {
    var container = document.getElementById('xtStatsContent');
    var totalLength = results.x[results.x.length - 1];
    var numSnapshots = results.xtData.length;
    
    container.innerHTML = 
        '<div><div style="font-weight:600;color:#495057;">Time Steps</div><div style="font-size:18px;">' + results.timeSteps.toLocaleString() + '</div></div>' +
        '<div><div style="font-weight:600;color:#495057;">Final Time</div><div style="font-size:18px;">' + (results.t * 1000).toFixed(2) + ' ms</div></div>' +
        '<div><div style="font-weight:600;color:#495057;">X-T Snapshots</div><div style="font-size:18px;">' + numSnapshots + '</div></div>' +
        '<div><div style="font-weight:600;color:#495057;">Domain Length</div><div style="font-size:18px;">' + totalLength.toFixed(2) + ' m</div></div>' +
        '<div><div style="font-weight:600;color:#495057;">Grid Points</div><div style="font-size:18px;">' + results.x.length + '</div></div>' +
        '<div><div style="font-weight:600;color:#495057;">Interfaces Tracked</div><div style="font-size:18px;">' + results.tracers.length + '</div></div>';
    
    document.getElementById('xtStatsContainer').style.display = 'block';
}

// Reset simulation
function resetXTSimulation() {
    xtSolver = null;
    xtResults = null;
    document.getElementById('xtCanvasContainer').style.display = 'none';
    document.getElementById('xtStatsContainer').style.display = 'none';
    document.getElementById('xtMessageContainer').innerHTML = '';
    document.getElementById('xtProgressContainer').style.display = 'none';
}

// Export functions
function exportXTImage() {
    if (!xtVisualization || !xtResults) {
        showXTMessage('No simulation results to export.', 'warning');
        return;
    }
    xtVisualization.exportImage('shock-tube-xt-diagram.png');
}

function exportXTDataCSV() {
    if (!xtResults) {
        showXTMessage('No simulation results to export.', 'warning');
        return;
    }
    
    // CSV header with all fields
    var csv = 'Time (ms),Position (m),Density (kg/m³),Velocity (m/s),Pressure (kPa),Temperature (K),Gamma,MW (g/mol),Gas ID\n';
    
    for (var j = 0; j < xtResults.xtData.length; j++) {
        var snapshot = xtResults.xtData[j];
        var t = snapshot.t * 1000;
        
        for (var i = 0; i < snapshot.p.length; i++) {
            csv += t.toFixed(4) + ',';                              // Time (ms)
            csv += xtResults.x[i].toFixed(4) + ',';                 // Position (m)
            csv += snapshot.rho[i].toFixed(4) + ',';                // Density (kg/m³)
            csv += snapshot.u[i].toFixed(4) + ',';                  // Velocity (m/s)
            csv += (snapshot.p[i] / 1000).toFixed(4) + ',';         // Pressure (kPa)
            csv += snapshot.T[i].toFixed(4) + ',';                  // Temperature (K)
            csv += snapshot.gamma[i].toFixed(6) + ',';              // Gamma
            csv += snapshot.mw[i].toFixed(4) + ',';                 // Molecular weight (g/mol)
            csv += snapshot.gasId[i] + '\n';                        // Gas ID
        }
    }
    
    downloadXTCSV(csv, 'xt-diagram-data.csv');
}

function exportXTTracerCSV() {
    if (!xtResults) {
        showXTMessage('No simulation results to export.', 'warning');
        return;
    }
    
    var csv = 'Interface,Time (ms),Position (m)\n';
    for (var i = 0; i < xtResults.tracers.length; i++) {
        var tracer = xtResults.tracers[i];
        for (var j = 0; j < tracer.trajectory.length; j++) {
            var point = tracer.trajectory[j];
            csv += (i + 1) + ',' + (point.t * 1000).toFixed(4) + ',' + point.x.toFixed(4) + '\n';
        }
    }
    
    downloadXTCSV(csv, 'tracer-trajectories.csv');
}

function exportXTJSON() {
    if (!xtResults) {
        showXTMessage('No simulation results to export.', 'warning');
        return;
    }
    
    var data = {
        configuration: {
            slabs: xtSlabs,
            gridPoints: parseInt(document.getElementById('xtGridPoints').value),
            simulationTime: parseFloat(document.getElementById('xtSimTime').value),
            cfl: parseFloat(document.getElementById('xtCflNumber').value)
        },
        results: xtResults
    };
    
    var json = JSON.stringify(data, null, 2);
    var blob = new Blob([json], { type: 'application/json' });
    var url = URL.createObjectURL(blob);
    var link = document.createElement('a');
    link.href = url;
    link.download = 'simulation-complete.json';
    link.click();
    URL.revokeObjectURL(url);
}

function downloadXTCSV(csv, filename) {
    var blob = new Blob([csv], { type: 'text/csv' });
    var url = URL.createObjectURL(blob);
    var link = document.createElement('a');
    link.href = url;
    link.download = filename;
    link.click();
    URL.revokeObjectURL(url);
}

function showXTMessage(message, type) {
    var colors = {
        'info': '#0066cc',
        'success': '#28a745',
        'warning': '#ffc107',
        'error': '#dc3545'
    };
    
    var container = document.getElementById('xtMessageContainer');
    container.innerHTML = '<div style="padding:12px;margin:10px 0;border-radius:3px;background-color:' + colors[type] + '20;border-left:4px solid ' + colors[type] + ';color:' + colors[type] + ';">' + message + '</div>';
    
    if (type === 'success') {
        setTimeout(function() {
            container.innerHTML = '';
        }, 5000);
    }
}
</script>

</body>
</html>
